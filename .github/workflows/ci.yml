name: CI

on:
  push:
    branches: [ main ]
  pull_request:

env:
  UV_VERSION: "0.9"
  PYTHON_VERSION: "3.14"
  BASE_LAYER: "bookworm"
  UV_CACHE_DIR: .uv-cache
  UV_SYSTEM_PYTHON: "1"

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/astral-sh/uv:${{ env.UV_VERSION }}-python${{ env.PYTHON_VERSION }}-${{ env.BASE_LAYER }}

    steps:
      - uses: actions/checkout@v4

      - run: apt-get update && apt-get install -y git

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.UV_CACHE_DIR }}
            /root/.cache/pre-commit
          key: uv-${{ hashFiles('uv.lock') }}

      - run: uv sync --all-extras --all-packages
      - run: uv run pre-commit run --all-files

  pytest:
    runs-on: ubuntu-latest
    needs: pre-commit
    container:
      image: ghcr.io/astral-sh/uv:${{ env.UV_VERSION }}-python${{ env.PYTHON_VERSION }}-${{ env.BASE_LAYER }}

    steps:
      - uses: actions/checkout@v4

      - run: apt-get update && apt-get install -y git

      - uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: uv-${{ hashFiles('uv.lock') }}

      - run: uv sync --all-extras --all-packages
      - run: uv run pytest

      - uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/
